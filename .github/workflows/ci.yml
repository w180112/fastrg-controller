name: FastRG Controller CI
on:
  push: 
    branches: 
      - master
      - ci-dev
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
    - name: Setup build environment
      uses: ./.github/actions/setup-build-env
    - name: Build
      run: make build
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
    - name: Setup build environment
      uses: ./.github/actions/setup-build-env
    - name: Run tests
      run: |
        make test
  docker-build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
    - name: Build Docker image
      run: |
        make docker-build
    - name: Save Docker image
      run: |
        docker save fastrg-controller:latest | gzip > fastrg-controller.tar.gz
    - name: Upload Docker image artifact
      uses: actions/upload-artifact@v6
      with:
        name: docker-image
        path: fastrg-controller.tar.gz
        retention-days: 1
  helm-lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
    - run: sudo apt update -y
    - name: Install Helm
      run: |
        curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
    - name: Lint Helm chart
      run: |
        helm lint deployment/helm/fastrg-controller
  helm-deployment:
    runs-on: ubuntu-latest
    needs: [build, test, docker-build, helm-lint]
    steps:
    - uses: actions/checkout@v6
    - name: Setup build environment
      uses: ./.github/actions/setup-build-env
    - name: Download Docker image artifact
      uses: actions/download-artifact@v7
      with:
        name: docker-image
    - name: Load Docker image
      run: |
        docker load < fastrg-controller.tar.gz
        docker images
    - name: Set up kubectl
      uses: azure/setup-kubectl@v4
      with:
        version: 'latest'
    - name: Set up Helm
      run: |
        curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
    - name: Install kind and cilium cli
      run: |
        curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.30.0/kind-linux-amd64
        chmod +x ./kind
        sudo mv ./kind /usr/local/bin/kind
        curl -Lo ./cilium.tar.gz https://github.com/cilium/cilium-cli/releases/latest/download/cilium-linux-amd64.tar.gz
        tar -xzf cilium.tar.gz
        sudo mv cilium /usr/local/bin/cilium
    - name: Create kind cluster
      run: |
        make k8s-create-test-env
    - name: Deploy service
      run: |
        make helm-install
    - name: Wait for deployment to be ready
      run: |
        kubectl wait --for=condition=available --timeout=360s deployment/fastrg-controller -n fastrg-system || true
        sleep 30
    - name: Verify deployment
      run: |
        deployment/k8s/deploy.sh --test-only || echo "⚠️ Service tests failed, but deployment completed"
        HOST_IP=$(ip route get 8.8.8.8 | awk '{print $7; exit}')
        export ETCD_ENDPOINTS="$HOST_IP:2379"
        echo "ETCD_ENDPOINTS is set to $ETCD_ENDPOINTS"
        tools/test_script.sh $HOST_IP run_feature_tests
  k8s-deployment:
    runs-on: ubuntu-latest
    needs: [build, test, docker-build]
    steps:
    - uses: actions/checkout@v6
    - name: Setup build environment
      uses: ./.github/actions/setup-build-env
    - name: Download Docker image artifact
      uses: actions/download-artifact@v7
      with:
        name: docker-image
    - name: Load Docker image
      run: |
        docker load < fastrg-controller.tar.gz
        docker images
    - name: Set up kubectl
      uses: azure/setup-kubectl@v4
      with:
        version: 'latest'
    - name: Install kind and cilium cli
      run: |
        curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.30.0/kind-linux-amd64
        chmod +x ./kind
        sudo mv ./kind /usr/local/bin/kind
        curl -Lo ./cilium.tar.gz https://github.com/cilium/cilium-cli/releases/latest/download/cilium-linux-amd64.tar.gz
        tar -xzf cilium.tar.gz
        sudo mv cilium /usr/local/bin/cilium
    - name: Create kind cluster
      run: |
        make k8s-create-test-env
    - name: Deploy service
      run: |
        make k8s-deploy
    - name: Wait for deployment to be ready
      run: |
        kubectl wait --for=condition=available --timeout=360s deployment/fastrg-controller -n fastrg-system || true
        sleep 30
    - name: Verify deployment
      run: |
        deployment/k8s/deploy.sh --test-only || echo "⚠️ Service tests failed, but deployment completed"
        HOST_IP=$(ip route get 8.8.8.8 | awk '{print $7; exit}')
        export ETCD_ENDPOINTS="$HOST_IP:2379"
        echo "ETCD_ENDPOINTS is set to $ETCD_ENDPOINTS"
        tools/test_script.sh $HOST_IP run_feature_tests
